<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Soundfont-player example</title>
	<style>
		input[type="text"] {
		width: 90%;
		display: block;
		font-size: 24px;
		}
		.instruments label {
		display: inline-block;
		width: 200px;
		cursor: pointer;
		}
	</style>
</head>
<body>
	<section>
		<h1><span id="titre"></span></h1>
		<p><small id="accompagnement"></small> <small><i>feat.</i></small> <small id="lead"></small></p>
		<p><small id="afficher_temps"></small><small id="afficher_mesure"></small><small id="mesures"></small></p>
	</section>
	<section class="instruments"></section>
	<script src="/dist/jquery-3.3.1.min.js"></script>
	<script src="/dist/soundfont-player.js"></script>
	<script src="/inclure/gammes.js"></script>
	<script src="/instruments/vents.js"></script>
	<script src="/instruments/pianos.js"></script>
	<script src="/instruments/basses.js"></script>
	<script src="/instruments/percussions.js"></script>

	<script>
$(document).ready(function(){
	// le temps de charger
	
	var g = gamme(62,"major"); // ré
	var nb_temps = 32 ;
	
	document.getElementById("titre").innerHTML = "Mélodie aléatoire en ré majeur" ;
	document.getElementById("mesures").innerHTML = " / "  + nb_temps ;
	
	var m = melodie(g, nb_temps);
	//console.log(m);
	
	// Theme 
	var ac = new AudioContext() ;
	
	// un instrument au hasard
	instrument = vents[ vents.length * Math.random() << 0]
	console.log(instrument);
	document.getElementById("lead").innerHTML = instrument ;

	// console.log(g);
	// charger un instrument
	Soundfont.instrument(ac, instrument).then(function (inst) {
		
		var start = ac.currentTime + 0.8 ;
		var time = ac.currentTime + 0.8;
		
		// jouer la melodie
		for (i=0; i < m.length; i++){
			inst.play(m[i].note,time, {duration: m[i].duree});
			time = time + m[i].duree ;
		}
		
		// accompagnement
		time = start ;
		instrument = pianos[ pianos.length * Math.random() << 0]
		Soundfont.instrument(ac, instrument).then(function (piano) {
			console.log(instrument);
			document.getElementById("accompagnement").innerHTML = instrument ;
			// jouer 
			for (i=1; i <= nb_temps; i++){
				
				degre = "I" ;
				if(i%8 >= 1 && i%16 >=9)
					degre = "II" ;
				if(i%8 >= 3 && i%16 >=11)
					degre = "V" ;
				if(i%8 >= 5 && i%16 >=13)
					degre = "I" ;
				
				//console.log(time);
				//console.log(i);
				//console.log(degre);
				
				var accord = notes_accord(g,degre);
				
				accord.forEach(function(e) {
					piano.play(e,time, {duration: 1});
				});
				time += 1 ;
			}
		time = time -1 ;
		//console.log("temps final");
		//console.log(time);
		setTimeout(function(){ window.location.reload(true); }, time*1000);
		})
	})
});
	</script>
	
</body>
</html>
